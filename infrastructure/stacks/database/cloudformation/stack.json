{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Parameters": {
      "Environment": {
        "Type": "String"
      },
      "DBInstanceClass": {
        "Type": "String"
      },
      "DBAllocatedStorage": {
        "Type": "Number"
      },
      "DBUsername": {
        "NoEcho": "true",
        "Type": "String",
        "MinLength": "1",
        "MaxLength": "16",
        "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
        "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters."
      },
      "DBPassword": {
        "NoEcho": "true",
        "Description": "Password MySQL database access",
        "Type": "String",
        "MinLength": "8",
        "MaxLength": "41",
        "AllowedPattern": "[a-zA-Z0-9]*",
        "ConstraintDescription": "must contain only alphanumeric characters."
      }
  },
  "Resources" : {
      "Database": {
          "DependsOn": ["DBSubnetGroup"],
          "Type": "AWS::RDS::DBInstance",
          "Properties": {
              "PubliclyAccessible": "true",
              "DBSubnetGroupName": {"Ref": "DBSubnetGroup"},
              "DBInstanceClass": {
                "Ref": "DBInstanceClass"
              },
              "AllocatedStorage": {
                "Ref": "DBAllocatedStorage"
              },
              "Engine": "MySQL",
              "EngineVersion": "8.0",
              "Port" : {"Fn::ImportValue": {"Fn::Join" : ["", ["database-port-", {"Ref": "Environment"}]]}},
              "MasterUsername": {
                "Ref": "DBUsername"
              },
              "MasterUserPassword": {
                "Ref": "DBPassword"
              },
            "VPCSecurityGroups" : [{"Fn::ImportValue":{"Fn::Join" : ["", ["database-security-group-", {"Ref": "Environment"}]]}}],
            "AvailabilityZone" : {"Fn::ImportValue": {"Fn::Join" : ["", ["availability-zone-", {"Ref": "Environment"}]]}}
          }
    },
      "DBSubnetGroup": {
      "Type" : "AWS::RDS::DBSubnetGroup",
      "Properties" : {
          "DBSubnetGroupDescription" : "Subnet group for database",
          "DBSubnetGroupName" : {"Fn::Join" : ["", ["database-subnet-group-", {"Ref": "Environment"}]]},
          "SubnetIds" :{"Fn::Split" : [ ",", {"Fn::ImportValue":{"Fn::Join" : ["", ["ec2-subnet-ids-", {"Ref": "Environment"}]]}}]}
      }
    }
  },
  "Outputs": {
      "DatabaseURL": {
          "Export": {
            "Name": {
              "Fn::Join": [
                "",
                [
                  "database-url-",
                  {
                    "Ref": "Environment"
                  }
                ]
              ]
            }
          },
          "Value": {"Fn::GetAtt": ["Database","Endpoint.Address"]}
      }
  }
}